name: Fly Preview

on:
  pull_request:
    branches:
      - main

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Define preview app name
        id: vars
        run: echo "APP_NAME=myapp-pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Create Fly app (if not exists)
        run: flyctl apps create ${{ steps.vars.outputs.APP_NAME }} --region gru || true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Set secrets for preview app
        run: |
          flyctl secrets set \
            JWTKEY="${{ secrets.JWTKEY }}" \
            CONNECTIONDB="${{ secrets.CONNECTIONDB }}" \
            EMAILSETTINGS__SMTPSERVER="${{ secrets.EMAILSETTINGS__SMTPSERVER }}" \
            EMAILSETTINGS__SMTPPORT="${{ secrets.EMAILSETTINGS__SMTPPORT }}" \
            EMAILSETTINGS__IMAPSERVER="${{ secrets.EMAILSETTINGS__IMAPSERVER }}" \
            EMAILSETTINGS__IMAPPORT="${{ secrets.EMAILSETTINGS__IMAPPORT }}" \
            EMAILSETTINGS__FROM="${{ secrets.EMAILSETTINGS__FROM }}" \
            EMAILSETTINGS__PASSWORD="${{ secrets.EMAILSETTINGS__PASSWORD }}" \
            KESTREL__CERTIFICATES__DEVELOPMENT__PASSWORD="${{ secrets.KESTREL__CERTIFICATES__DEVELOPMENT__PASSWORD }}" \
            -a ${{ steps.vars.outputs.APP_NAME }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy preview app
        run: |
          flyctl deploy --remote-only -a ${{ steps.vars.outputs.APP_NAME }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Comment preview URL on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          message: |
            ðŸš€ **Preview deploy criado!**
            URL: https://${{ steps.vars.outputs.APP_NAME }}.fly.dev
